# Requirements Document

## Project Overview

小説のテキストをマンガ形式に自動変換するWebアプリケーション。Mastra AIフレームワークを活用し、通常のLLMでは扱えない長文の小説テキストからマンガレイアウトの自動配置を実現します。右上から左下に進む日本の漫画スタイルであることが重要。

## Project Description

ユーザーが小説やラノベのテキストを入力すると、自動的にマンガ形式のページレイアウトに変換するアプリケーション。Mastra AIフレームワークを使用して、テキストから登場人物・シーン・対話・ハイライト・状況の5要素の抽出、連載漫画としてのエピソードへの構成、コマ割り、吹き出し配置などを自動化する。TypeScriptで実装。

## Core Requirements

### 1. Text Processing Pipeline

- **長文対応**: 通常のLLMの制限を超える長文テキスト（小説全体）の処理
- **チャンク分割**: テキストを効率的に分析可能なチャンクに自動分割
- **スライディング分析**: 前後のコンテキストを保持した重複分析による連続性確保
- **5要素抽出**: 各チャンクから登場人物・シーン・対話・ハイライト・状況を抽出

### 2. Episode Structure Generation

- **エピソード構成**: 分析されたチャンクから連載漫画用のエピソード構造を自動生成
- **ページ分割**: 各エピソードを適切なページ数（20-50ページ推奨）に分割
- **継続性管理**: エピソード間の物語の連続性とキャラクター一貫性を維持
- **フォールバック処理**: 短いコンテンツの場合は単一エピソードに統合

### 3. Layout Generation System

- **JSON設計**: 各ページのレイアウトをJSON形式で定義・保存（YAML廃止済み）
- **コマ割り**: パネル数に基づく自動コマ割りとテンプレート選択
- **吹き出し配置**: セリフとキャラクターに応じた吹き出しの自動配置
- **日本式レイアウト**: 右上から左下への読み順を考慮したレイアウト
- **バリデーション**: パネルの重複チェック、境界正規化、参照テンプレートへのフォールバック

### 4. Rendering System

- **Canvas描画**: HTMLCanvasを使用したストーリーボード描画
- **バッチレンダリング**: 複数ページの並列処理とプログレス管理
- **垂直テキスト**: 日本語縦書きテキスト描画の統合（オプション機能）
- **エクスポート**: 完成したレイアウトのPNG/PDF出力

### 5. Data Persistence

- **ジョブ管理**: 処理状況の永続化と中断・再開機能
- **段階的保存**: 各処理段階でのデータ自動保存
- **プログレス追跡**: エピソード・ページレベルでの詳細進捗管理
- **エラー復旧**: 処理失敗時の状態復旧とリトライ機能

### 6. User Interface

- **リアルタイム更新**: 処理進捗のリアルタイム表示
- **結果ブラウジング**: 生成されたマンガレイアウトのページ別閲覧
- **共有機能**: 結果の共有とエクスポート
- **エラー表示**: 処理エラーの詳細情報表示

### 7. Technical Architecture

- **Cloudflare統合**: Workers/Pages/D1/R2/KVを活用した分散処理
- **LLMプロバイダー**: OpenRouter/Gemini/Claudeのフォールバックチェーン
- **型安全性**: TypeScript strict modeによる型安全性確保
- **テスト戦略**: Unit/Integration/E2Eテストの包括的カバレッジ
- **JSON統一**: すべてのデータフォーマットをJSONに統一（YAML完全廃止）

## Quality Requirements

### Performance

- **レスポンス時間**: API応答時間の最適化（< 30秒/リクエスト）
- **並列処理**: 複数エピソード・ページの並列処理による高速化
- **キャッシュ戦略**: LLM応答とレンダリング結果の効率的キャッシュ

### Reliability

- **エラーハンドリング**: 包括的エラー処理と詳細ログ記録
- **復旧機能**: 処理中断からの自動復旧
- **データ整合性**: データベースとストレージの整合性保証

### Maintainability

- **モジュール化**: 機能別の疎結合な設計
- **設定集約**: すべての設定の中央集権化
- **ドキュメント**: 設計文書とタスク管理の同期維持

## Data Format Standards

- **統一フォーマット**: すべてのデータ交換・保存にJSON形式を使用
- **YAML廃止**: レイアウトデータのYAML形式は完全に廃止済み
- **型安全性**: Zod schemaによるJSON構造の厳密な型検証

## Constraints

### Technical

- **TypeScript**: `any`型の使用禁止、strict mode必須
- **Cloudflare**: Workers環境でのNode.js APIの制限
- **LLM制限**: プロバイダー別のレート制限とトークン制限

### Business

- **処理時間**: 1小説あたりの処理時間上限（数時間以内）
- **コスト**: LLM APIコストの最適化
- **ストレージ**: 中間ファイルとキャッシュの容量管理

---

**STATUS**: ✅ 実装完了
**CURRENT VERSION**: 本要件書は2025年8月現在の実装状況を反映

## Copilot規約のCursor最適化版

本ファイルは `.github/copilot-instructions.md` の内容をCursorでの開発運用に合わせて最適化したものです。エディタ支援での変更は「最小編集・型安全・テスト合格」を厳守してください。

### 非交渉ルール（毎回必須）

- 最新公式ドキュメントの取得・参照: Web検索や使用可能ならMCP/Deepwikiを用い、一次情報を優先。検証できない情報に依存しない。
  - Mastra / Cloudflare: 変更前に最新API/制限を確認し、根拠URLをPRやコードコメントに記載。
- TypeScript: any禁止。精密な型（unknown + type guards, generics, discriminated unions）。`ts-ignore`/`ts-expect-error` は正当化コメントと追跡タスク付きで最小限。
- Lint/Format: エラー/警告は解消。安易なルール無効化は不可（正当化と記録がある場合のみ）。
- DRY: 重複排除。共通化して再利用。
- SOLID: 単一責任、開放/閉鎖、LSP、ISP、DI。継承より合成、テストしやすい境界を維持。

### プロジェクト規約

- ユニットテスト: `src/__tests__` 配下。公開挙動の変更には必ずテストを追加/更新。テストランナーはVitest。
- E2E: 重要フローはPlaywrightで実装・実行（非対話で安定実行）。
- 一時スクリプト: `tmp_test/` に配置し、一時用途を明記。mainへマージ前に削除または無効化。

### 設計・タスク・データ契約（同一PRで同期）

- システム設計: 適切な設計ドキュメントを `docs/` 配下に更新・追加（本来の参照先が存在しない場合、`docs/kiro/` など既存構成に合わせる）。
- タスク分解: 上記設計ドキュメントと同階層に `tasks.md` を更新し、スコープ/ステータス/受入基準を同期。
- データベース: Drizzle使用。単一の真実の源は `src/db/schema.ts`。スキーマ変更とマイグレーション生成/適用をコード変更と同時に行い、乖離させない。
- ストレージレイアウト: `database/storage-structure.md` を実際のファイル配置、バケット/パス、保持ルールに合わせて更新。

### 技術別指針

- Mastra: パイプライン/オペレータ/設定の追加・更新時は最新ドキュメントで互換性確認し、参照リンクをPRまたはコードコメントに記載。
- Cloudflare（Workers/Pages/D1/R2/Queues等）: 最新API/制限を確認。`wrangler.toml` を正確に保ち、必要なbindingsを明記。可能ならバージョン固定。
- ライブラリ導入/更新: 安定性/保守状況/移行ノートを調査し、根拠リンクと理由をPRに記載。

### 品質ゲート（マージ前に必須）

- ビルド成功かつTypeScriptエラーゼロ（anyなし）。
- Linter/Formatterはエラーゼロ、説明なき無効化はなし。
- ユニットテスト（`src/__tests__`）合格。主要フローのE2E（Playwright）合格。必要に応じて統合テストも合格。
- ドキュメント/仕様/タスクを同PRで更新（設計、タスク、`src/db/schema.ts` + マイグレーション、`database/storage-structure.md`）。
- 重複コードなし。共通ユーティリティへ適切に抽出。

### PRチェックリスト（PRに貼り付けてチェック）

- [ ] Mastra/Cloudflare/関連ライブラリの最新ドキュメントを取得して参照リンクをPRに記載
- [ ] any型を導入していない（やむを得ない例外は根拠コメント/追跡タスク付き）
- [ ] Linter/Formatterクリーン（エラー0）かつ無根拠のルール無効化なし
- [ ] DRY/SOLIDを満たし冗長実装がない
- [ ] `src/__tests__` のユニットテストを追加/更新し合格
- [ ] PlaywrightのE2Eシナリオを追加/更新し合格（主要フロー）
- [ ] 設計ドキュメント（`docs/` 配下）を最新化
- [ ] タスクドキュメント（`docs/` 配下の `tasks.md` 等）を最新化
- [ ] `src/db/schema.ts` 更新 + 必要なマイグレーション生成/適用
- [ ] `database/storage-structure.md` を更新

### CLIツールポリシー

- gh（GitHub CLI）: ブランチ/PR作成・更新、コメント投稿、CI確認に使用可。重要操作（内容/理由/URL）はPR説明かコメントに要約。
- rp（PR helper CLI）: 利用可能な環境ではPR自動化に使用可。
- rg（ripgrep）: 高速検索に推奨。グロブ/--typeで範囲を絞り、過度な生ログ貼付は避け要約。
- jq: JSONの抽出/変換に使用可。複雑な式は読みやすく分割し、簡潔な補足コメントを添える。

### テスト実行ポリシー（対話ハングの回避）

- 非対話で実行する。ウォッチ/対話モードは開発中のローカルに限定。
  - 単発実行: `npm test`（`vitest run`）。
  - ウォッチUIで `h`/`q` が出たら誤モード。`q`で終了し `npm test` に切替。
  - CI/自動化では `vitest` 単体や `--ui` を使わない。
  - 統合テストは `npm run test:integration:run`（非対話）を優先。

### Cursor向け補足

- 編集は最小単位で行い、関連テスト/型/ドキュメントを同時更新。
- 既存のインデント文字と幅（タブ/スペース）を厳守し、混在・変換を禁止。
- 変更前後で以下の順に確認:
  ```bash
  npm run typecheck && npm run lint && npm test
  ```
- コード提案では既存の関数/型/ユーティリティを再利用し、重複定義を避ける。

# 統合テストベストプラクティス実装ガイド

## 概要

従来のサーバー起動が必要な統合テストから、熟達したエンジニアが採用するベストプラクティスに基づく新しい統合テスト設計に移行しました。

## 新しい統合テスト設計

### 1. テスト分類

#### A. API契約テスト (`api-contracts.test.ts`)

- **目的**: API エンドポイントの入出力契約を検証
- **範囲**: リクエスト/レスポンス形式、エラーハンドリング
- **実行方式**: Next.js API routesを直接呼び出し（サーバー起動不要）

#### B. サービス統合テスト (`service-integration.test.ts`)

- **目的**: 複数のサービス層の協調動作を検証
- **範囲**: データベース操作、ストレージ操作、ビジネスロジック
- **実行方式**: インメモリDB + モックストレージ

#### C. ワークフローテスト (`workflow.test.ts`)

- **目的**: エンドツーエンドの業務フローを検証
- **範囲**: 複数APIの連携、データ永続化、状態遷移
- **実行方式**: API呼び出しチェーン

### 2. ベストプラクティス適用

#### Test Double戦略

```typescript
// Stub: 外部API（LLMサービス）
setupAgentMocks() // 安定した結果を返すStub

// Real: データベース、ファイルシステム
createTestDatabase() // 実際のSQLite in-memory
TestMemoryStorage() // 実装に近いメモリストレージ

// Mock: 設定可能な外部依存
vi.mock('@/config', () => ({ ... }))
```

#### データ管理（AAA Pattern）

```typescript
beforeEach(async () => {
  // Arrange: テストデータセットアップ
  testDb = await createTestDatabase();
  testStorage = new TestStorageFactory();
});

it("test case", async () => {
  // Act: テスト対象実行
  const result = await apiCall();

  // Assert: 結果検証
  expect(result.success).toBe(true);
});

afterEach(async () => {
  // Cleanup: テストデータクリーンアップ
  await cleanupTestDatabase(testDb);
});
```

## 新旧統合テスト比較

| 観点             | 旧統合テスト                  | 新統合テスト                  |
| ---------------- | ----------------------------- | ----------------------------- |
| **サーバー**     | Next.js dev server必要        | 不要（API route直接呼び出し） |
| **データベース** | 外部SQLite or PostgreSQL      | インメモリSQLite              |
| **ストレージ**   | 実ファイルシステム            | インメモリストレージ          |
| **LLMサービス**  | 実API呼び出し or 環境変数制御 | モック（安定した結果）        |
| **実行速度**     | 遅い（10分+ timeout）         | 高速（30秒 timeout）          |
| **並列実行**     | 困難（ポート競合）            | 可能（分離されたリソース）    |
| **CI/CD**        | 複雑（サーバー起動管理）      | 簡単（通常のテストと同様）    |
| **デバッグ**     | 困難（サーバーログと分離）    | 容易（単一プロセス）          |

## 実装済みコンポーネント

### 1. テストヘルパー (`src/__tests__/integration/__helpers/`)

#### `test-database.ts`

- インメモリSQLiteデータベース作成
- マイグレーション実行
- テストデータファクトリー
- クリーンアップ機能

#### `test-storage.ts`

- インメモリストレージ実装
- Storage interfaceに準拠
- デバッグ用ダンプ機能

#### `test-agents.ts`

- LLMエージェントのStub実装
- 安定した分析結果を提供
- 実際のAPI呼び出しを排除

### 2. 実装済みテストケース

#### API契約テスト

```bash
npm run test:integration -- api-contracts
```

#### サービス統合テスト

```bash
npm run test:integration -- service-integration
```

#### ワークフローテスト

```bash
npm run test:integration -- workflow
```

## 使用方法

### 1. 新統合テストの実行

```bash
# 全ての新統合テストを実行
npm run test:integration

# 特定のテストファイルを実行
npm run test:integration -- api-contracts.test.ts

# ウォッチモード
npm run test:integration:watch
```

### 2. 従来の統合テストについて

従来のサーバー起動が必要な統合テストは削除されました。必要に応じてGitの履歴から復元できます。

## 移行戦略

### フェーズ1: 新統合テスト基盤構築 ✅完了

- [x] テストヘルパー実装
- [x] Vitest設定
- [x] 基本的なテストケース作成

### フェーズ2: レガシー統合テストからの移行 ✅完了

1. **旧統合テストの削除**
   - `tests/integration/` ディレクトリを完全削除
   - 関連スクリプト(`run-integration-test.*`)を削除
   - `package.json`スクリプトをクリーンアップ
   - Playwright設定を無効化

2. **CI/CDでの競合解消**
   - サーバー起動が不要な新統合テストのみ実行
   - 高速で安定したテスト環境を実現

### フェーズ3: CI/CD統合

- GitHub Actions ワークフローの更新
- パフォーマンス最適化
- レポート機能の拡充

## 利点

### 1. 開発者体験の向上

- **高速実行**: 30秒以内で完了
- **簡単なデバッグ**: 単一プロセスでのテスト実行
- **安定性**: 外部依存の排除による一貫した結果

### 2. CI/CDの改善

- **並列実行**: 複数のテストジョブを同時実行可能
- **リソース効率**: サーバー起動不要
- **信頼性**: 環境依存問題の解決

### 3. メンテナンス性

- **明確な責任分離**: API、サービス、ワークフロー層の分離
- **モジュラー設計**: 再利用可能なテストコンポーネント
- **文書化**: 明確なテスト意図とカバレッジ

## 今後の拡張

### 1. 追加テストタイプ

- **パフォーマンステスト**: 大量データでの動作検証
- **同期テスト**: 並行処理の検証
- **エラー回復テスト**: 障害シナリオの検証

### 2. ツールの改善

- **カバレッジ分析**: 統合テストカバレッジの可視化
- **レポート生成**: HTMLレポートの自動生成
- **メトリクス収集**: テスト実行時間、成功率の追跡

## 結論

新しい統合テスト設計により、サーバー起動が不要で高速、安定、保守性の高いテスト環境を実現しました。従来の統合テストの課題を解決し、現代的な開発ワークフローに適合したテストインフラを提供します。

この設計は、熟達したエンジニアが採用する以下のベストプラクティスを反映しています：

- **Test Pyramid**: 適切なテスト分類と責任分離
- **Fast Feedback**: 高速な実行とデバッグ容易性
- **Deterministic**: 一貫した結果と外部依存の排除
- **Maintainable**: モジュラー設計と明確な抽象化

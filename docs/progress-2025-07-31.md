# Novel2Manga 開発進捗レポート (2025-07-31)

## 概要
本日は、Novel-to-Manga変換システムの大規模なデータ構造変更と、レイアウト生成エージェントの実装を完了しました。主な成果として、Novel最上位のデータ構造への移行、包括的なジョブ管理システムの構築、パネルレイアウト生成機能の実装が完了しました。

## 完了したタスク

### 1. ✅ データ構造の大規模変更（Novel最上位構造への移行）

#### 新しいデータベーススキーマの実装
- **階層構造の変更**: Novel → Job → 各処理ステップという明確な階層
- **新規テーブルの追加**:
  - `novels`: 小説の基本情報とメタデータ管理
  - `job_step_history`: 各処理ステップの実行履歴
  - `chunk_analysis_status`: チャンクごとの分析完了状態
  - `layout_status`: エピソードごとのレイアウト生成状態
  - `render_status`: ページごとの描画状態
  - `outputs`: PDF/CBZ等の最終成果物管理
  - `storage_files`: すべてのファイルの追跡管理
- **jobsテーブルの拡張**:
  - 各ステップの完了フラグ（split_completed, analyze_completed等）
  - 詳細な進捗追跡（total_chunks, processed_chunks等）
  - 再開用の状態保存機能（resume_data_path）
  - エラー管理（last_error, retry_count）
- **ビューの追加**:
  - `novel_status_view`: 小説の変換状況一覧
  - `job_progress_view`: ジョブの詳細進捗
  - `resumable_jobs`: 再開可能なジョブ一覧

#### 型定義の拡張
- `workers/src/types/index.ts`にJobStatus、ExtendedJob、JobProgress、Episode型を追加
- NarrativeProcessingStateをJobのprogressフィールドに統合

#### DatabaseServiceの拡張
- 新しいメソッドを追加
  - `getExtendedJob`: 拡張されたジョブ情報を取得
  - `updateJobStatus`: ジョブステータスの更新
  - `updateJobProgress`: 進捗状態の保存
  - `createEpisode`, `createEpisodes`: エピソード情報の保存
  - `getEpisodesByJobId`: エピソード一覧の取得
- トランザクション処理（batch）の実装

#### NarrativeProcessorの刷新
- 古いファイルベースのNarrativeProcessorを削除
  - `/src/services/narrative-processor.ts`
  - `/src/utils/narrative-state.ts`
  - `/src/types/narrative-processing.ts`
- 新しい`JobNarrativeProcessor`を作成（`/src/services/job-narrative-processor.ts`）
  - D1データベースベースの状態管理
  - JobIDベースの進捗追跡
  - エラーハンドリングとリトライ機能
  - 指数バックオフによるリトライ遅延

#### APIエンドポイントの整備
- `/api/jobs/[jobId]/status` - ジョブステータス取得
- `/api/jobs/[jobId]/episodes` - エピソード一覧取得
- `/api/jobs/[jobId]/resume` - 中断したジョブの再開
- `/api/analyze/narrative-arc/full` - 新システムに対応

### 2. ✅ レイアウト生成エージェントの実装

#### パネルレイアウトの型定義 (`/src/types/panel-layout.ts`)
- YAML構造に対応する型定義を作成
- エピソード → チャンク → ページ → パネルの階層構造を定義
- 日本式マンガの右から左への読み方向に対応

#### レイアウトテンプレート (`/src/utils/layout-templates.ts`)
- サンプルYAMLから抽出した実用的なテンプレート
- **重要なルール**：
  - 田の字のような均等なグリッド分割は絶対に避ける
  - コマのサイズに変化をつけて視覚的なリズムを作る
  - ハイライトシーンは大きなコマで表現する
- テンプレート例：
  - `six-conversation`: 6コマ会話シーン用
  - `five-emotion-focus`: 5コマ感情表現用
  - `four-climax`: 4コマクライマックス用

#### レイアウト生成エージェント (`/src/agents/layout-generator.ts`)
- Mastraエージェントとしての実装
- チャンク分析結果からパネル内容を生成
- LLMでパネル内容を決定し、テンプレートで配置
- 均等分割を検出して自動調整

#### レイアウト生成API (`/src/app/api/layout/generate/route.ts`)
- エピソード番号を指定してレイアウトを生成
- チャンク分析結果を読み込んで統合
- YAMLファイルとして出力（`.local-storage/layouts/[jobId]/`）

#### 設定の集約 (`/src/config/app.config.ts`)
- レイアウト生成用の設定を追加
  - `instructions`: レイアウト生成の指示
  - `systemPrompt`: システムプロンプト
  - プロバイダー別のモデル設定
- LLMプロンプトをソースコードから分離

### 3. ✅ エピソード構成とレイアウト連携

#### エピソード分割機能の実装
- エピソード境界の自動検出
- チャンクまたぎのエピソード対応
- 各エピソードの推定ページ数算出
- 信頼度スコアによる品質管理

### 4. ⏳ エンドポイントの統合（進行中）

#### 問題点
- エンドポイントが分散している
  - `src/app/api/` - Next.js App Routerのエンドポイント
  - `workers/src/routes/` - Cloudflare Workersのエンドポイント

#### 統合作業
- `workers/src/routes/analyze.ts` → `src/app/api/analyze/route.ts`への移行を開始
- `workers/src/routes/job.ts` → `src/app/api/job/[id]/route.ts`への移行を開始
- 開発環境とプロダクション環境の分岐処理を実装

## 技術的な改善点

### SOLID原則の適用
- **単一責任の原則**: 各クラス・関数が単一の責任を持つように設計
- **開放閉鎖の原則**: 拡張に対して開き、修正に対して閉じた設計
- **依存性逆転の原則**: DatabaseServiceを介した抽象化

### エラーハンドリングの強化
- リトライ可能なエラーの判定ロジック
- 指数バックオフによるリトライ遅延
- 部分的な成功状態の管理

### パフォーマンスの考慮
- バッチ処理による効率的なデータベース操作
- 非同期処理の活用
- 適切なインデックスの設定

## 次のステップ

### 高優先度タスク
1. **エンドポイントの統合完了**
   - workers配下のエンドポイントをすべてsrc/app/api配下に移行
   - 開発環境用のローカルストレージ実装の完成

2. **Canvas APIによるレイアウト描画**
   - コマ枠の描画実装
   - 吹き出しの配置と描画機能

### 中優先度タスク
- D1データベースへの分析結果保存機能
- R2ストレージへのファイル保存実装
- フロントエンドUIコンポーネントの構築

## 現在の実装状況

### 実装済みの機能
1. **データ管理**
   - Novel/Job/Chunk/Episode/Storage全体の統合管理
   - D1データベースによる状態管理
   - ファイルストレージ（R2/ローカル）の抽象化

2. **処理フロー**
   - テキスト分割（チャンク化）
   - チャンク分析（5要素抽出）
   - ナラティブアーク分析（エピソード境界検出）
   - レイアウト生成（YAML形式）

3. **エージェント**
   - ChunkAnalyzerAgent（5要素抽出）
   - NarrativeArcAnalyzerAgent（物語構造分析）
   - LayoutGeneratorAgent（パネルレイアウト生成）

### 未実装の機能
1. **描画システム**
   - Canvas APIによるコマ枠描画
   - 吹き出しの配置と描画
   - 絵コンテスタイルの仕上げ

2. **UI/UX**
   - マンガプレビューコンポーネント
   - インタラクティブな編集機能
   - エクスポート機能のUI

3. **認証・共有**
   - NextAuth.jsによる認証
   - 72時間限定共有リンク

## 使用技術スタック
- **フレームワーク**: Next.js 15 (App Router)
- **AIフレームワーク**: Mastra
- **LLMプロバイダー**: OpenRouter, Groq, OpenAI, Gemini
- **デプロイ**: Cloudflare Workers (OpenNext adapter)
- **データベース**: Cloudflare D1 (SQLite)
- **ストレージ**: Cloudflare R2
- **言語**: TypeScript
- **スタイリング**: TailwindCSS

## まとめ
本日は、システムアーキテクチャの根本的な改善を実施しました。Novel最上位のデータ構造への変更により、より直感的で管理しやすいシステムになりました。新しいスキーマは以下の利点を提供します：

1. **明確な階層構造**: Novel → Job → 各処理ステップという論理的な流れ
2. **包括的な状態管理**: 各処理ステップの詳細な進捗と状態を追跡
3. **堅牢なエラー処理**: リトライ機能と詳細なエラー記録
4. **柔軟な再開機能**: 中断されたジョブの任意のステップからの再開
5. **効率的なファイル管理**: すべてのファイルの統一的な追跡

また、日本のマンガ特有のレイアウトルール（均等分割の回避、視覚的リズムの重視）を実装に反映させることができました。
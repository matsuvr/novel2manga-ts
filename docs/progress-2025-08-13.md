# 2025-08-13 進捗メモ

## 概要

- デモ経路（分割→仮レイアウト→描画）の導入と型安全化を実施
- シナリオDSL（ScenarioBuilder）の導入で処理の宣言的オーケストレーションを整備
- キュー雛形と通知導線を追加し、APIからのエンキュー/再開フローを確認

## 今日の進捗（サマリ）

### デモオーケストレーションと型安全化

- 共通デモ判定 `detectDemoMode()` を追加（`src/utils/request-mode.ts`）し、`/api/analyze`・`/api/layout/generate` に適用
- デモ用アダプタ（`src/services/adapters/index.ts`）を Zod で入出力検証、`withRetry` を適用して安定化
- `createDemoApiScenario()` を追加し、`analyze-demo → layout-demo → render-demo` の一連を `/api/scenario/run` で実行可能に
- 単体テスト追加：`utils-request-mode.test.ts` / `adapters-demo.test.ts`

### シナリオDSL（ScenarioBuilder）

- 型付きステップと契約（`src/types/contracts.ts`）に基づく DAG 構築を導入（`src/services/orchestrator/scenario.ts`）
- `mapField` による fan-out 設計の下地を整え、後続で fan-in/集約を行う拡張余地を確保
- UI 表示の足場（`ScenarioViewer.tsx`）と API（`/api/scenario/run`）整備

### キュー雛形と通知導線

- インプロセスキューの雛形と API 連携を追加（`src/services/queue.ts`）
- `/api/jobs/[jobId]`・`/api/jobs/[jobId]/resume` からのエンキュー/再開を確認
- 失敗時の DB 更新（`updateJobError`）および通知スタブ（`src/services/notifications.ts`）を追加

## 主要変更ハイライト

```
src/
├─ utils/request-mode.ts                 # デモ/通常判定（Zod safeParse）
├─ services/adapters/index.ts            # デモ/本番アダプタ、Zod検証 + withRetry
├─ services/orchestrator/scenario.ts     # ScenarioBuilder（型安全なDSL）
├─ app/api/scenario/run/route.ts         # シナリオ実行API
├─ app/api/analyze/route.ts              # デモ検出の適用
├─ app/api/layout/generate/route.ts      # デモ時のYAML自動生成・保存
├─ app/api/render/route.ts               # YAML自動読込（デモ/通常共通）
├─ services/queue.ts                     # インプロセスキュー雛形
├─ services/notifications.ts             # 通知スタブ（ENVでON/OFF）
└─ __tests__/...
```

## 既知の課題 / 未完了タスク（抜粋）

- デモ用レイアウトテンプレートの外部化（Magic Values 排除）
- E2E: `/api/scenario/run { kind: 'demo' }` のハッピーパス
- Cloudflare Queues/DO 実行ランタイムへの移行（キュー実体、冪等性、再配信設計）
- Scene 正規化（Chunk → Flexible → Core）の永続化前適用とテスト整備

## 明日やること（優先順）

- デモテンプレートの外部化と検証ユーティリティの追加
- `/api/scenario/run` の E2E テスト（Playwright）
- Queue Runtime の下準備（idempotencyKey、Envelope整備、R2外部化ポリシー）
- ドキュメント更新の追従（design.md/taks.md、storage-structure.md 必要箇所）

## 動作確認メモ（手元）

- 型/品質: `npm run typecheck && npm run check`
- ユニット: `npm run test:unit`（request-mode/adapters/scenario）
- 統合/E2E: `npm run test:integration` / `npm run test:e2e`

以上。デモ経路とシナリオDSLを土台に、Queue/DO への移行と E2E の整備へ進める状態です。

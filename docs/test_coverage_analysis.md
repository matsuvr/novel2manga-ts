# テストカバレッジ分析レポート

## 1. 総評

現在のテストスイートは、主要なAPIエンドポイント、ドメインモデル、リポジトリ、およびコアサービスを中心に、広範囲なカバレッジを提供しています。特に、統合テスト (`integration/`) とE2Eテスト (`e2e/`) が充実しており、システム全体のワークフローの堅牢性を保証する上で重要な役割を果たしています。

しかし、いくつかの領域でテストの冗長性が見られ、また、一部の重要なユーティリティやサービスコンポーネントに対するテストが不足している可能性があります。

## 2. 冗長または価値の低い可能性のあるテスト

以下のテストは、内容が単純すぎる、他のテストと重複している、あるいは設定のみを検証しているため、削減または統合を検討する価値があります。

- `src/__tests__/sample.test.ts`
  - **理由:** `1 + 1` をテストするようなサンプルコードであり、実際のプロジェクトのロジックを検証していません。プロジェクト初期の動作確認用ファイルである可能性が高く、現在は不要です。
- `src/__tests__/api/health.test.ts`
  - **理由:** ヘルスチェックAPIの基本的な成功・失敗ケースをテストしていますが、このロジックはE2Eテスト (`e2e/api-integration.spec.ts`) でもカバーされています。ユニットテストとして残す価値はありますが、E2Eテストと内容が重複している点を認識しておくべきです。
- `src/__tests__/domain/emotion.test.ts`
  - **理由:** `EmotionSchema` が任意の文字列を受け入れることをテストしていますが、これはスキーマ定義そのものの性質をテストしているに過ぎません。より複雑なバリデーションロジックが追加されない限り、このテストの価値は限定的です。
- `src/__tests__/repositories/adapters-structure.test.ts`
  - **理由:** アダプターの構造（`entity`や`mode`プロパティ）をテストしています。これは型定義や構造が意図せず変更されることを防ぐ上で有用ですが、静的な設定の検証であり、動的なロジックのテストではありません。
- `src/__tests__/repositories/ports-guards.test.ts`
  - **理由:** リポジトリポートの型ガードを検証しています。これは型安全性を保証する上で重要ですが、アプリケーションのビジネスロジックそのものをテストするものではありません。

## 3. テストカバレッジが不足している可能性のある領域

ファイル名ベースでの分析によると、以下の領域ではテストが不足している可能性があります。これらのコンポーネントはエラーハンドリング、設定管理、ビジネスロジックの中核を担うため、重点的にテストを追加することが推奨されます。

### 3.1. エージェント (`src/agent/` `src/agents/`)

- `src/agent/structured-generator.ts`, `src/agent/tools.ts`
  - **理由:** `AgentCore` のテストは存在しますが、構造化データ生成やツール登録・実行のロジックに特化したテストが不足しています。
- `src/agents/llm/`
  - **理由:** `cerebras-agent.test.ts` は存在しますが、`openai-compatible.ts` や `router.ts` など、他のLLM関連ロジックに対するテストが不足しています。特にフォールバックやルーティングロジックは重要です。

### 3.2. サービス (`src/services/`)

- `src/services/orchestrator/`
  - **理由:** シナリオの実行とオーケストレーションはシステムの根幹ですが、このディレクトリ配下にテストが見当たりません。`scenario-dsl.test.ts` はDSLの検証であり、実際のオーケストレーションロジックのテストではありません。
- `src/services/application/output-service.ts`, `src/services/application/job-details.ts`
  - **理由:** ジョブの成果物や詳細情報の取得ロジックは、ユーザーに直接影響を与える部分ですが、対応するテストが見当たりません。

### 3.3. ユーティリティ (`src/utils/`)

- `src/utils/api-error.ts`, `src/utils/api-responder.ts`, `src/utils/http-errors.ts`
  - **理由:** APIのエラーハンドリングとレスポンス生成は、APIの安定性と信頼性に直結します。`extract-error-message.test.ts` はありますが、APIレスポンスを構築する部分のテストが不足しています。
- `src/utils/cloudflare-env.ts`, `src/utils/logger.ts`
  - **理由:** 環境変数の解決やロギングは、デバッグと運用において極めて重要です。これらのユーティリティに対するユニットテストが不足しています。

### 3.4. ライブラリ/キャンバス (`src/lib/`)

- `src/lib/canvas/panel-layout-engine.ts`, `src/lib/canvas/speech-bubble-placer.ts`, `src/lib/canvas/thumbnail-generator.ts`
  - **理由:** `canvas-renderer.test.ts` や `manga-page-renderer.test.ts` は存在しますが、レイアウト計算や吹き出し配置など、より具体的な描画ロジックを担うモジュールのテストが不足しています。

## 4. 推奨事項

1.  **低価値テストの削除/統合:**
    - `src/__tests__/sample.test.ts` は削除を推奨します。
    - `health.test.ts` の内容はE2Eテストでカバーされているため、重複を許容するか、ユニットテスト側をより詳細なケース（DBのみダウン、ストレージのみダウンなど）に特化させるかを検討してください。
2.  **カバレッジ不足領域へのテスト追加:**
    - **最優先:** `src/services/orchestrator/` と `src/utils/api-error.ts`、`src/utils/api-responder.ts` にユニットテストを追加し、コアロジックとエラーハンドリングを強化することを推奨します。
    - **高優先:** `src/agents/llm/router.ts` や `src/lib/canvas/panel-layout-engine.ts` など、条件分岐や計算ロジックを多く含むモジュールにテストを追加してください。
3.  **テストの責務の明確化:**
    - ユニットテストは個々の関数のロジック（特にエッジケース）を検証することに集中させ、API間の連携や全体的なフローは統合テスト・E2Eテストに任せることで、テストの重複を減らし、保守性を向上させることができます。

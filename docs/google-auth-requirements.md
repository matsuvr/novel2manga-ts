# Google認証統合 要件

## 概要

本ドキュメントは、`novel2manga-ts` に Google ログインを導入するための要件を整理する。OpenNext と Cloudflare Workers 環境で、Auth.js v5 と D1 を組み合わせた認証基盤を構築し、アプリケーション側のデータモデルや非同期処理基盤と整合させる。

## 機能要件

- **認証方式**: Google OAuth を利用し、Auth.js の D1 Adapter を用いてユーザー管理を行う。
- **エンドポイント構成**: `/portal/api/auth` 配下に `login`・`callback/:provider`・`logout`・`session` を配置し、既存の `/api` ルートと衝突しないようにする。
- **データベース**: Auth.js 標準の `users`, `accounts`, `sessions`, `verification_tokens` テーブルは D1 Adapter に任せる。アプリ固有のデータは `app_` プレフィックス付きテーブルで管理し、Drizzle ORM でスキーマを定義する。
- **ジョブ管理**: 変換ジョブ (`app_jobs`) と成果物 (`app_artifacts`) を D1 に保存し、Cloudflare Queues を使って非同期処理を実行する。
- **成果物配布**: 生成されたファイルは R2 に保存し、プリサインド URL を発行して配布する。
- **メール通知**: ジョブの成功・失敗時に Resend を用いて通知メールを送信する。
- **退会フロー**: `/portal-api/me` に対する DELETE リクエストで退会を受け付け、専用 Queue コンシューマで関連データを削除する。

## 非機能要件

- **セキュリティ**: プリサインド URL は短寿命とし、認証済みユーザーのみがジョブデータや成果物にアクセスできるようにする。
- **拡張性**: Auth.js のテーブルとアプリ固有テーブルを分離し、将来的なスキーマ変更に備える。
- **可観測性**: Queue の滞留状況やジョブ処理の成功率、メール送信結果をロギングする。
- **レート制限**: ジョブ作成やメール送信回数に制限を設けるための設定値を `*.config.ts` に集約する。

## 成功条件

- Google アカウントでログインし、保護されたポータル機能にアクセスできる。
- 新規ジョブ作成時に Queue へメッセージが送信され、コンシューマ Worker が D1 と R2 を更新できる。
- ジョブ完了後にユーザーへメール通知が送信され、成果物の URL を取得できる。
- 退会実行後、D1・R2・Auth.js の関連データが削除され、再ログインできない。

# Progress — 2025-08-16

## Summary

- Implemented YAML-stage layout validation and deterministic fallback to reference panel layouts to stabilize manga page geometry generated by the LLM.
- Embedded reference panel geometries (1–6 panels) into code for Cloudflare/Workers compatibility (no filesystem I/O at runtime).
- Surfaced validation outcomes to API and UI:
  - Backend writes per-page issues and normalized page lists into `episode_{n}.progress.json`.
  - Job status API (`GET /api/jobs/[jobId]/status`) now exposes validation under `job.progress.perEpisodePages[episodeNumber].validation`.
  - UI shows episode-level “Normalized” badges and per-page badges on the episode preview screen.

## Key Changes

- Validation/Normalization
  - `src/utils/layout-normalizer.ts`
    - Bounds clamp for positions/sizes; pairwise overlap detection; vertical band partition (ensures horizontal coverage ≈ 1 without gaps/overlaps).
    - Reference fallback when invalid: maps panel contents to the closest reference geometry (1–6 panels) using Japanese reading order.
    - Returns normalized layout and per-page issues.

- Reference Layouts (embedded)
  - `src/utils/reference-layouts.ts`
    - In-code reference geometries derived from `docs/panel_layout_sample.yaml` and `docs/panel_layout_sample2.yaml` and templates.
    - Used by the normalizer for Workers-safe operation.

- Service Integration
  - `src/services/application/layout-generation.ts`
    - Applies normalization for demo, batch snapshots, and final YAML.
    - Persists `validation` block into `episode_{n}.progress.json` (pageIssues, normalizedPages, pagesWithIssueCounts).
  - `src/services/application/job-progress.ts`
    - Parses progress validation and enriches `job.progress.perEpisodePages[episodeNumber].validation` with normalizedPages, pagesWithIssueCounts, and issuesCount.

- UI Updates
  - `src/components/ProcessingProgress.tsx`
    - Shows a yellow “Normalized N” badge on episode cards when pages were auto-corrected.
    - Legend updated to include Normalized explanation.
  - `src/app/novel/[novelId]/results/[jobId]/episode/[episodeNumber]/page.tsx`
    - Displays a per-page “Normalized” pill with issue count when applicable (reads `episode_{n}.progress.json`).

- Tests
  - `src/__tests__/utils/layout-normalizer.test.ts`: overlap and band-coverage validation, normalization/fallback behavior.
  - `src/__tests__/job-status.integration.test.ts`: asserts validation surfaces in perEpisodePages.validation.

## Rationale

Retrying the LLM does not guarantee valid panel geometry. Deterministic correction via validated templates ensures usable layouts immediately while preserving content/dialogues. Embedded references avoid runtime filesystem access in Workers.

## Follow-ups

- Expose page-level issue details in the UI (optional sidebar or tooltip).
- Add Playwright E2E to verify Normalized badges appear when validation data is present.
- Consider storing validation summaries alongside renders for auditability.

# E2Eテスト仕様書

本ドキュメントはNovel2Mangaの主要ユーザーフローを対象としたE2Eテストの仕様をまとめる。
Playwrightを利用し、実ブラウザ上でのユーザー操作を再現することを前提とする。

## 1. サインアップフロー

- **目的**: 利用規約に同意しないと送信できないことを確認する。
- **前提条件**: 未ログイン状態で`/sign-up`にアクセス。
- **手順**:
  1. メール欄に有効なメールアドレスを入力。
  2. 同意チェックボックスをオンにする前に送信ボタンが無効であることを確認。
  3. チェックボックスをオンにし送信ボタンが有効化されることを確認。
  4. 送信ボタンをクリックし送信が実行されることを確認。
- **期待結果**: 同意前は送信不可。チェック後に送信可能となり、フォーム送信が完了する。
- **実装**: `tests/integration/e2e/sign-up.spec.ts`

## 2. Google OAuthログイン

- **目的**: Googleでログインボタンが`next-auth`の`signIn`を呼び出すことを確認する。
- **前提条件**: 未ログイン状態で`/portal/auth/signin`にアクセス。
- **手順**:
  1. 「Googleでログイン」ボタンをクリック。
  2. `signIn`がGoogleプロバイダを指定して呼び出されることをモックで検証。
- **期待結果**: `signIn('google')`が呼び出され、ポータルダッシュボードへリダイレクトされる。
- **実装**: `tests/integration/e2e/google-oauth.spec.ts`

## 3. 新規小説変換フロー

- **目的**: ホームから小説テキストを入力し結果表示までの一連の流れを検証する。
- **前提条件**: ログイン済みで`/`にアクセス。
- **手順**:
  1. テキスト入力エリアに小説を貼り付け「変換」ボタンを押下。
  2. プログレス表示に遷移し処理ステータスが更新されることを確認。
  3. 処理完了後に結果ページへ自動リダイレクトされることを確認。
  4. 結果ページで生成されたエピソード一覧が表示されることを確認。
- **期待結果**: 入力→処理→結果表示までエラーなく遷移し、エピソードが一覧表示される。

## 4. 途中ジョブの再開

- **目的**: 既存ジョブIDを指定して途中から処理を再開できることを確認する。
- **前提条件**: 再開可能なジョブIDが存在すること。
- **手順**:
  1. ホーム画面の「処理を再開」欄にジョブIDを入力し再開ボタンを押下。
  2. プログレス画面に遷移しジョブの進捗が表示されることを確認。
- **期待結果**: 指定したジョブの進捗が取得され、処理完了時に結果ページへ遷移する。

## 5. ポータルダッシュボード

- **目的**: ログイン後にジョブ一覧が正しく表示され、フィルタ・ページングが機能することを確認する。
- **前提条件**: ログイン済みで複数のジョブが存在する。
- **手順**:
  1. `/portal/dashboard`へアクセスしジョブカードが表示されることを確認。
  2. ステータスフィルタを切り替えて表示内容が更新されることを確認。
  3. ページング操作により次ページのジョブが表示されることを確認。
- **期待結果**: ジョブのフィルタリングとページングが期待通りに動作し、各ジョブへの詳細リンクが有効。

## 6. ジョブ詳細ページ

- **目的**: 各ジョブの詳細情報とエピソードリンクが閲覧できることを確認する。
- **前提条件**: ログイン済みで任意のジョブIDを持つ。
- **手順**:
  1. `/portal/jobs/{jobId}`へアクセス。
  2. ジョブのステータスや関連情報が表示されることを確認。
  3. 各エピソードへのリンクが機能しページ遷移できることを確認。
- **期待結果**: 詳細情報が正確に表示され、エピソードページに遷移できる。

## 7. 設定とアカウント削除

- **目的**: ユーザー設定の表示とアカウント削除フローを検証する。
- **前提条件**: ログイン済みで`/portal/settings`にアクセス。
- **手順**:
  1. 設定ページがロードされることを確認。
  2. 「アカウント削除」ボタンを押下し確認ダイアログが表示されることを確認。
  3. ダイアログで削除を確定するとログアウトしトップページへ遷移することを確認。
- **期待結果**: 確認ダイアログを経てアカウントが削除され、ユーザーは未ログイン状態に戻る。

## 8. 認証ガード

- **目的**: 認証が必要なページへ未ログインでアクセスした場合にログインページへリダイレクトされることを確認する。
- **手順**:
  1. 未ログイン状態で`/portal/dashboard`へ直接アクセス。
  2. `/portal/auth/signin`へリダイレクトされることを確認。
- **期待結果**: すべてのポータル配下ページで認証ガードが有効に働く。

## 9. 無効なURLパラメータ

- **目的**: 不正な`novelId`または`jobId`でアクセスした場合に404が返ることを確認する。
- **手順**:
  1. `/novel/invalid-id/progress`へアクセス。
  2. 404ページが表示されることを確認。
- **期待結果**: パラメータ不正時は404が返却される。

## 10. メール通知送信

- **目的**: 処理完了時に登録メールアドレスへ通知が送られることを確認する。
- **前提条件**: 通知機能が有効でテスト用メールサーバーが稼働している。
- **手順**:
  1. 新規小説変換を実行。
  2. 処理完了後、テストメールサーバーに通知メールが届くことを確認。
- **期待結果**: 変換完了メールが指定アドレスに1通送信される。

---

これらのテストケースを基にPlaywrightによるE2Eテストを実装し、主要なユーザーストーリーの回帰テストを自動化する。

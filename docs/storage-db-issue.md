# ストレージとデータベース整合性の問題調査

## 背景

- ストレージとデータベースの整合性を検証する統合テストが安定して失敗する。
- `max retry` を増やすと稀に成功することから、非同期処理の遅延が原因と考えられる。
- 本サービスでは保存処理が完了した時点でデータベースとストレージが同期していることが必須要件であり、遅延が発生する設計は要件を満たさない。

## 現状の問題

- データベース更新とストレージ書き込みが別々に非同期実行されており、双方が完了する前にレスポンスを返している可能性がある。
- テストは即時の整合性を前提としているため、処理が遅延すると失敗する。

## 検討すべき対応

1. **実装の見直し**
   - データベース更新とストレージ書き込みを同一トランザクションやワークフローで扱い、どちらかが失敗した場合はロールバックする。
   - 非同期処理を行う場合でも、完了通知を待つか、キューやイベントで確実に同期させる仕組みを導入する。
2. **テストの再検討**
   - サービス側で強整合性を保証するなら、テストは現在のままでよい。
   - もし最終的な整合性を許容する設計に変更するなら、テスト側でポーリングやイベント待機を行い、一定時間内に整合性が取れれば成功とするよう修正する。

## 結論

- 要件は保存処理完了時点での整合性を求めているため、テストの問題ではなく実装を改修すべきである。
- 非同期処理の見直しとトランザクション管理を含む設計変更を検討し、統合テストを再度実行して確実に成功することを確認する。

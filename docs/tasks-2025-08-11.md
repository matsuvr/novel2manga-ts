# 2025年8月11日 タスクリスト

## 今日の優先タスク（高）
- Database: render 状態の厳密化
  - `DatabaseService.updateRenderStatus` を `render_status` テーブルへの UPSERT に対応
  - 取得系（job/episode/page）メソッドの整備とユニットテスト追加

- 共有リンク基盤の追加
  - `shares` テーブル設計・マイグレーション・Repository 実装
  - `/api/share` に共有情報の保存（token, jobId, expiresAt, episodeNumbers）を実装
  - 参照/検証用の GET エンドポイント（閲覧時検証）を用意

- エラー応答の統一
  - すべての API で `createErrorResponse/successResponse` を使用
  - 既存テストと互換が必要な箇所は `toLegacyErrorResponse` を使用

## 今日の優先タスク（中）
- Cloudflare / Wrangler 設定の充実
  - `wrangler.toml` に `LAYOUTS_STORAGE` / `RENDERS_STORAGE` を追記
  - `npm run cf-typegen` を実行し bindings タイプの更新を確認

- OpenAPI スキーマ生成の実用化
  - 主要エンドポイント（analyze/render/export/jobs系）の zod スキーマをレジストリへ集約
  - `scripts/generate-openapi.ts` を複数レジストリ取込に対応し、CI で `openapi.json` 出力

- Repository 層の DI 標準化
  - Repository Factory を導入して DB ポート注入を一元化（Job/Episode/Novel/Output）
  - ルート直参照の `DatabaseService` を置換（段階的）

- UI/UX（進捗と失敗の扱い）
  - `ProcessingProgress` のポーリング間隔/タイムアウト/再開 UI 強化
  - `jobs/[jobId]/episodes` が 404 のときのガイダンスとリトライ動作を改善

## 今日の優先タスク（低）
- バッチ描画のスキップ/並列制御仕上げ
  - `/api/render/batch` の `options.skipExisting` を有効化（headで存在確認）
  - 失敗ページの再実行ユーティリティ（単発/範囲指定）

- テストの充実
  - ユニット: render/export/repository の基本ケース
  - 統合: 小説→分析→エピソード→レイアウト→描画→エクスポートのハッピーパス
  - E2E: サンプルテキストから ZIP/PDF ダウンロード確認

- ストレージ仕様ドキュメント更新
  - `database/storage-structure.md` にキー命名・メタデータ・保存契約を最新化

- セキュリティ/運用
  - `.env.example` の網羅確認と README にシークレット運用手順を追記
  - 必要なら `.test-storage/` を `.gitignore` に追加

- 監視/ロギング/リトライ
  - LLM/API 呼び出しの `withRetry` 適用範囲見直し（RateLimit/Timeout）
  - 重要ルートに計測ログ（処理時間・件数）を追加

## ドキュメント/ハウスキーピング
- README 初期化（概要/セットアップ/主要コマンド/テスト/CF/Wrangler/DB 運用）
- `docs/` の進捗・タスクを本日版へ更新
- サンプル小説ボタンのロード通知とエラー表示の改善

## 実行コマンド（参考）
- 開発: `npm run dev`
- 型/品質: `npm run typecheck && npm run check:ci`
- テスト: `npm run test:unit` / `npm run test:integration` / `npm run test:e2e`
- OpenAPI: `npm run generate:openapi`
- Cloudflare: `npm run cf-typegen`


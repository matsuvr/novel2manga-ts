# 統合テスト設計ガイド

## テスト分類とベストプラクティス

### 1. テストピラミッド

```
        E2E Tests (少数)
      /               \
   Integration Tests (中程度)
  /                           \
Unit Tests (大部分)
```

### 2. 統合テストの定義

このプロジェクトでは、統合テストを以下のように定義します：

- **複数のモジュール/層の協調動作をテスト**
- **外部依存（DB、ファイルシステム、HTTP）は実装に近い形でテスト**
- **サーバー起動は不要（Next.js API routesを直接呼び出し）**
- **実際のDBを使用（テスト用SQLite in-memory）**

### 3. テスト種別

#### A. Contract Tests（契約テスト）

- API エンドポイントの入出力契約をテスト
- リクエスト/レスポンス形式の検証
- エラーハンドリングの検証

#### B. Service Integration Tests（サービス統合テスト）

- 複数のサービス層の協調動作をテスト
- データベース操作を含む
- ファイルストレージ操作を含む

#### C. Workflow Tests（ワークフローテスト）

- 完全な業務フローをテスト
- 複数のAPIエンドポイントを順次呼び出し
- データの永続化と取得を検証

## ベストプラクティス

### 1. Test Double戦略

- **Stub**: 外部API（LLMサービス）
- **Spy**: ログ・メトリクス
- **Real**: データベース、ファイルシステム
- **Mock**: 設定可能な外部依存

### 2. データ管理

- **Arrange**: テスト用データのセットアップ
- **Act**: テスト対象の実行
- **Assert**: 結果の検証
- **Cleanup**: テストデータのクリーンアップ

### 3. 独立性の確保

- 各テストは独立して実行可能
- テスト間でのデータ依存なし
- 並列実行をサポート

### 4. 性能とメンテナンス性

- 高速な実行（< 10秒）
- 明確なテスト名と意図
- 適切な抽象化レベル
